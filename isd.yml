
apiVersion: scaffolder.backstage.io/v1beta3
kind: Template
metadata:
  description: ArgoCD Application For ISD with Helm values override
  name: argocd-application-isd
  title: ArgoCD Application ISD
spec:
  owner: guests
  type: service
  parameters:
    - title: ArgoCD Configuration Options
      required:
        - name
      properties:
        apiVersion:
          default: argoproj.io/v1alpha1
          description: APIVersion for the resource
          type: string
          ui:readonly: true
        kind:
          default: Application
          description: Kind for the resource
          type: string
          ui:readonly: true
        name:
          type: string
          title: Application Name
          description: Application Name
          maxLength: 52
          pattern: ^[a-z0-9]([-a-z0-9]*[a-z0-9])?(\.[a-z0-9]([-a-z0-9]*[a-z0-9])?)*$
          default: testappname
          ui:placeholder: Enter application name
          ui:help: An application name must start with a lowercase alphabet or number,
            containonly lowercase alphabets, numbers, and hyphens, and cannot
            start or end with a hyphen. The length must not exceed 53
            characters.
        namespace:
          description: Namespace for the resource
          namespace: default
          type: string
          default: argocd
        config:
          description: ApplicationSpec represents desired application state. Contains link
            to repository with application definition and additional parameters
            link definition revision.
          properties:
            project:
              description: Project is a reference to the project this application belongs to.
                The empty string means that application belongs to the 'default'
                project.
              type: string
              default: default
            destination:
              description: Destination is a reference to the target Kubernetes server and
                namespace
              properties:
                name:
                  description: Name is an alternate way of specifying the target cluster by its
                    symbolic name. This must be set if Server is not set.
                  type: string
                  default: in-cluster
                namespace:
                  description: Namespace specifies the target namespace for the application's
                    resources. The namespace will only be set for
                    namespace-scoped resources that have not set a value for
                    .metadata.namespace
                  type: string
                  default: default
                server:
                  description: Server specifies the URL of the target cluster's Kubernetes control
                    plane API. This must be set if Name is not set.
                  type: string
              type: object
            source:
              description: Source is a reference to the location of the application's
                manifests or chart
              properties:
                repoURL:
                  description: RepoURL is the URL to the repository (Git or Helm) that contains
                    the application manifests
                  type: string
                targetRevision:
                  description: TargetRevision defines the revision of the source to sync the
                    application to. In case of Git, this can be commit, tag, or
                    branch. If omitted, will equal to HEAD. In case of Helm,
                    this is a semver tag for the Chart's version.
                  type: string
                path:
                  description: Path is a directory path within the Git repository, and is only
                    valid for applications sourced from Git.
                  type: string
                chart:
                  description: Chart is a Helm chart name, and must be specified for applications
                    sourced from a Helm repo.
                  type: string
                directory:
                  description: Directory holds path/directory specific options
                  properties:
                    exclude:
                      description: Exclude contains a glob pattern to match paths against that should
                        be explicitly excluded from being used during manifest
                        generation
                      type: string
                    include:
                      description: Include contains a glob pattern to match paths against that should
                        be explicitly included during manifest generation
                      type: string
                    jsonnet:
                      description: Jsonnet holds options specific to Jsonnet
                      properties:
                        extVars:
                          description: ExtVars is a list of Jsonnet External Variables
                          items:
                            description: JsonnetVar represents a variable to be passed to jsonnet during
                              manifest generation
                            properties:
                              code:
                                type: boolean
                              name:
                                type: string
                              value:
                                type: string
                            required:
                              - name
                              - value
                            type: object
                          type: array
                        libs:
                          description: Additional library search dirs
                          items:
                            type: string
                          type: array
                        tlas:
                          description: TLAS is a list of Jsonnet Top-level Arguments
                          items:
                            description: JsonnetVar represents a variable to be passed to jsonnet during
                              manifest generation
                            properties:
                              code:
                                type: boolean
                              name:
                                type: string
                              value:
                                type: string
                            required:
                              - name
                              - value
                            type: object
                          type: array
                      type: object
                    recurse:
                      description: Recurse specifies whether to scan a directory recursively for
                        manifests
                      type: boolean
                  type: object
                helm:
                  description: Helm holds helm specific options
                  properties:
                    fileParameters:
                      description: FileParameters are file parameters to the helm template
                      items:
                        description: HelmFileParameter is a file parameter that's passed to helm
                          template during manifest generation
                        properties:
                          name:
                            description: Name is the name of the Helm parameter
                            type: string
                          path:
                            description: Path is the path to the file containing the values for the Helm
                              parameter
                            type: string
                        type: object
                      type: array
                    ignoreMissingValueFiles:
                      description: IgnoreMissingValueFiles prevents helm template from failing when
                        valueFiles do not exist locally by not appending them to
                        helm template --values
                      type: boolean
                    parameters:
                      description: Parameters is a list of Helm parameters which are passed to the
                        helm template command upon manifest generation
                      items:
                        description: HelmParameter is a parameter that's passed to helm template during
                          manifest generation
                        properties:
                          forceString:
                            description: ForceString determines whether to tell Helm to interpret booleans
                              and numbers as strings
                            type: boolean
                          name:
                            description: Name is the name of the Helm parameter
                            type: string
                          value:
                            description: Value is the value for the Helm parameter
                            type: string
                        type: object
                      type: array
                    passCredentials:
                      description: PassCredentials pass credentials to all domains (Helm's
                        --pass-credentials)
                      type: boolean
                    releaseName:
                      description: ReleaseName is the Helm release name to use. If omitted it will use
                        the application name
                      type: string
                    skipCrds:
                      description: SkipCrds skips custom resource definition installation step (Helm's
                        --skip-crds)
                      type: boolean
                    valueFiles:
                      description: ValuesFiles is a list of Helm value files to use when generating a
                        template
                      items:
                        type: string
                      type: array
                    values:
                      description: Values specifies Helm values to be passed to helm template,
                        typically defined as a block. ValuesObject takes
                        precedence over Values, so use one or the other.
                      type: string
                    valuesObject:
                      description: ValuesObject specifies Helm values to be passed to helm template,
                        defined as a map. This takes precedence over Values.
                      type: object
                      x-kubernetes-preserve-unknown-fields: true
                    version:
                      description: Version is the Helm version to use for templating ("3")
                      type: string
                  type: object
                kustomize:
                  description: Kustomize holds kustomize specific options
                  properties:
                    commonAnnotations:
                      additionalProperties:
                        type: string
                      description: CommonAnnotations is a list of additional annotations to add to
                        rendered manifests
                      type: object
                    commonAnnotationsEnvsubst:
                      description: CommonAnnotationsEnvsubst specifies whether to apply env variables
                        substitution for annotation values
                      type: boolean
                    commonLabels:
                      additionalProperties:
                        type: string
                      description: CommonLabels is a list of additional labels to add to rendered
                        manifests
                      type: object
                    components:
                      description: Components specifies a list of kustomize components to add to the
                        kustomization before building
                      items:
                        type: string
                      type: array
                    forceCommonAnnotations:
                      description: ForceCommonAnnotations specifies whether to force applying common
                        annotations to resources for Kustomize apps
                      type: boolean
                    forceCommonLabels:
                      description: ForceCommonLabels specifies whether to force applying common labels
                        to resources for Kustomize apps
                      type: boolean
                    images:
                      description: Images is a list of Kustomize image override specifications
                      items:
                        description: KustomizeImage represents a Kustomize image definition in the
                          format [old_image_name=]<image_name>:<image_tag>
                        type: string
                      type: array
                    namePrefix:
                      description: NamePrefix is a prefix appended to resources for Kustomize apps
                      type: string
                    nameSuffix:
                      description: NameSuffix is a suffix appended to resources for Kustomize apps
                      type: string
                    namespace:
                      description: Namespace sets the namespace that Kustomize adds to all resources
                      type: string
                    patches:
                      description: Patches is a list of Kustomize patches
                      items:
                        properties:
                          options:
                            additionalProperties:
                              type: boolean
                            type: object
                          patch:
                            type: string
                          path:
                            type: string
                          target:
                            properties:
                              annotationSelector:
                                type: string
                              group:
                                type: string
                              kind:
                                type: string
                              labelSelector:
                                type: string
                              name:
                                type: string
                              namespace:
                                type: string
                              version:
                                type: string
                            type: object
                        type: object
                      type: array
                    replicas:
                      description: Replicas is a list of Kustomize Replicas override specifications
                      items:
                        properties:
                          count:
                            anyOf:
                              - type: integer
                              - type: string
                            description: Number of replicas
                            x-kubernetes-int-or-string: true
                          name:
                            description: Name of Deployment or StatefulSet
                            type: string
                        required:
                          - count
                          - name
                        type: object
                      type: array
                    version:
                      description: Version controls which version of Kustomize to use for rendering
                        manifests
                      type: string
                  type: object
                plugin:
                  description: Plugin holds config management plugin specific options
                  properties:
                    env:
                      description: Env is a list of environment variable entries
                      items:
                        description: EnvEntry represents an entry in the application's environment
                        properties:
                          name:
                            description: Name is the name of the variable, usually expressed in uppercase
                            type: string
                          value:
                            description: Value is the value of the variable
                            type: string
                        required:
                          - name
                          - value
                        type: object
                      type: array
                    name:
                      type: string
                    parameters:
                      items:
                        properties:
                          array:
                            description: Array is the value of an array type parameter.
                            items:
                              type: string
                            type: array
                          map:
                            additionalProperties:
                              type: string
                            description: Map is the value of a map type parameter.
                            type: object
                          name:
                            description: Name is the name identifying a parameter.
                            type: string
                          string:
                            description: String_ is the value of a string type parameter.
                            type: string
                        type: object
                      type: array
                  type: object
                ref:
                  description: Ref is reference to another source within sources field. This field
                    will not be used if used with a `source` tag.
                  type: string
              type: object
            syncPolicy:
              description: SyncPolicy controls when and how a sync will be performed
              properties:
                automated:
                  description: Automated will keep an application synced to the target revision
                  properties:
                    allowEmpty:
                      description: "AllowEmpty allows apps have zero live resources (default: false)"
                      type: boolean
                    prune:
                      description: "Prune specifies whether to delete resources from the cluster that
                        are not found in the sources anymore as part of
                        automated sync (default: false)"
                      type: boolean
                    selfHeal:
                      description: "SelfHeal specifies whether to revert resources back to their
                        desired state upon modification in the cluster (default:
                        false)"
                      type: boolean
                  type: object
                managedNamespaceMetadata:
                  description: ManagedNamespaceMetadata controls metadata in the given namespace
                    (if CreateNamespace=true)
                  properties:
                    annotations:
                      additionalProperties:
                        type: string
                      type: object
                    labels:
                      additionalProperties:
                        type: string
                      type: object
                  type: object
                retry:
                  description: Retry controls failed sync retry behavior
                  properties:
                    backoff:
                      description: Backoff controls how to backoff on subsequent retries of failed
                        syncs
                      properties:
                        duration:
                          description: Duration is the amount to back off. Default unit is seconds, but
                            could also be a duration (e.g. "2m", "1h")
                          type: string
                        factor:
                          description: Factor is a factor to multiply the base duration after each failed
                            retry
                          format: int64
                          type: integer
                        maxDuration:
                          description: MaxDuration is the maximum amount of time allowed for the backoff
                            strategy
                          type: string
                      type: object
                    limit:
                      description: Limit is the maximum number of attempts for retrying a failed sync.
                        If set to 0, no retries will be performed.
                      format: int64
                      type: integer
                  type: object
                syncOptions:
                  description: Options allow you to specify whole app sync-options
                  items:
                    type: string
                  type: array
              type: object
            ignoreDifferences:
              description: IgnoreDifferences is a list of resources and their fields which
                should be ignored during comparison
              items:
                description: ResourceIgnoreDifferences contains resource filter and list of json
                  paths which should be ignored during comparison with live
                  state.
                properties:
                  group:
                    type: string
                  jqPathExpressions:
                    items:
                      type: string
                    type: array
                  jsonPointers:
                    items:
                      type: string
                    type: array
                  kind:
                    type: string
                  managedFieldsManagers:
                    description: ManagedFieldsManagers is a list of trusted managers. Fields mutated
                      by those managers will take precedence over the desired
                      state defined in the SCM and won't be displayed in diffs
                    items:
                      type: string
                    type: array
                  name:
                    type: string
                  namespace:
                    type: string
                required:
                  - kind
                type: object
              type: array
            info:
              description: Info contains a list of information (URLs, email addresses, and
                plain text) that relates to the application
              items:
                properties:
                  name:
                    type: string
                  value:
                    type: string
                required:
                  - name
                  - value
                type: object
              type: array
            revisionHistoryLimit:
              description: RevisionHistoryLimit limits the number of items kept in the
                application's revision history, which is used for informational
                purposes as well as for rollbacks to previous versions. This
                should only be changed in exceptional circumstances. Setting to
                zero will store no history. This will reduce storage used.
                Increasing will increase the space used to store the history, so
                we do not recommend increasing it. Default is 10.
              format: int64
              type: integer
            sources:
              description: Sources is a reference to the location of the application's
                manifests or chart
              items:
                description: ApplicationSource contains all required information about the
                  source of an application
                properties:
                  chart:
                    description: Chart is a Helm chart name, and must be specified for applications
                      sourced from a Helm repo.
                    type: string
                  directory:
                    description: Directory holds path/directory specific options
                    properties:
                      exclude:
                        description: Exclude contains a glob pattern to match paths against that should
                          be explicitly excluded from being used during manifest
                          generation
                        type: string
                      include:
                        description: Include contains a glob pattern to match paths against that should
                          be explicitly included during manifest generation
                        type: string
                      jsonnet:
                        description: Jsonnet holds options specific to Jsonnet
                        properties:
                          extVars:
                            description: ExtVars is a list of Jsonnet External Variables
                            items:
                              description: JsonnetVar represents a variable to be passed to jsonnet during
                                manifest generation
                              properties:
                                code:
                                  type: boolean
                                name:
                                  type: string
                                value:
                                  type: string
                              required:
                                - name
                                - value
                              type: object
                            type: array
                          libs:
                            description: Additional library search dirs
                            items:
                              type: string
                            type: array
                          tlas:
                            description: TLAS is a list of Jsonnet Top-level Arguments
                            items:
                              description: JsonnetVar represents a variable to be passed to jsonnet during
                                manifest generation
                              properties:
                                code:
                                  type: boolean
                                name:
                                  type: string
                                value:
                                  type: string
                              required:
                                - name
                                - value
                              type: object
                            type: array
                        type: object
                      recurse:
                        description: Recurse specifies whether to scan a directory recursively for
                          manifests
                        type: boolean
                    type: object
                  helm:
                    description: Helm holds helm specific options
                    properties:
                      fileParameters:
                        description: FileParameters are file parameters to the helm template
                        items:
                          description: HelmFileParameter is a file parameter that's passed to helm
                            template during manifest generation
                          properties:
                            name:
                              description: Name is the name of the Helm parameter
                              type: string
                            path:
                              description: Path is the path to the file containing the values for the Helm
                                parameter
                              type: string
                          type: object
                        type: array
                      ignoreMissingValueFiles:
                        description: IgnoreMissingValueFiles prevents helm template from failing when
                          valueFiles do not exist locally by not appending them
                          to helm template --values
                        type: boolean
                      parameters:
                        description: Parameters is a list of Helm parameters which are passed to the
                          helm template command upon manifest generation
                        items:
                          description: HelmParameter is a parameter that's passed to helm template during
                            manifest generation
                          properties:
                            forceString:
                              description: ForceString determines whether to tell Helm to interpret booleans
                                and numbers as strings
                              type: boolean
                            name:
                              description: Name is the name of the Helm parameter
                              type: string
                            value:
                              description: Value is the value for the Helm parameter
                              type: string
                          type: object
                        type: array
                      passCredentials:
                        description: PassCredentials pass credentials to all domains (Helm's
                          --pass-credentials)
                        type: boolean
                      releaseName:
                        description: ReleaseName is the Helm release name to use. If omitted it will use
                          the application name
                        type: string
                      skipCrds:
                        description: SkipCrds skips custom resource definition installation step (Helm's
                          --skip-crds)
                        type: boolean
                      valueFiles:
                        description: ValuesFiles is a list of Helm value files to use when generating a
                          template
                        items:
                          type: string
                        type: array
                      values:
                        description: Values specifies Helm values to be passed to helm template,
                          typically defined as a block. ValuesObject takes
                          precedence over Values, so use one or the other.
                        type: string
                      valuesObject:
                        description: ValuesObject specifies Helm values to be passed to helm template,
                          defined as a map. This takes precedence over Values.
                        type: object
                        x-kubernetes-preserve-unknown-fields: true
                      version:
                        description: Version is the Helm version to use for templating ("3")
                        type: string
                    type: object
                  kustomize:
                    description: Kustomize holds kustomize specific options
                    properties:
                      commonAnnotations:
                        additionalProperties:
                          type: string
                        description: CommonAnnotations is a list of additional annotations to add to
                          rendered manifests
                        type: object
                      commonAnnotationsEnvsubst:
                        description: CommonAnnotationsEnvsubst specifies whether to apply env variables
                          substitution for annotation values
                        type: boolean
                      commonLabels:
                        additionalProperties:
                          type: string
                        description: CommonLabels is a list of additional labels to add to rendered
                          manifests
                        type: object
                      components:
                        description: Components specifies a list of kustomize components to add to the
                          kustomization before building
                        items:
                          type: string
                        type: array
                      forceCommonAnnotations:
                        description: ForceCommonAnnotations specifies whether to force applying common
                          annotations to resources for Kustomize apps
                        type: boolean
                      forceCommonLabels:
                        description: ForceCommonLabels specifies whether to force applying common labels
                          to resources for Kustomize apps
                        type: boolean
                      images:
                        description: Images is a list of Kustomize image override specifications
                        items:
                          description: KustomizeImage represents a Kustomize image definition in the
                            format [old_image_name=]<image_name>:<image_tag>
                          type: string
                        type: array
                      namePrefix:
                        description: NamePrefix is a prefix appended to resources for Kustomize apps
                        type: string
                      nameSuffix:
                        description: NameSuffix is a suffix appended to resources for Kustomize apps
                        type: string
                      namespace:
                        description: Namespace sets the namespace that Kustomize adds to all resources
                        type: string
                      patches:
                        description: Patches is a list of Kustomize patches
                        items:
                          properties:
                            options:
                              additionalProperties:
                                type: boolean
                              type: object
                            patch:
                              type: string
                            path:
                              type: string
                            target:
                              properties:
                                annotationSelector:
                                  type: string
                                group:
                                  type: string
                                kind:
                                  type: string
                                labelSelector:
                                  type: string
                                name:
                                  type: string
                                namespace:
                                  type: string
                                version:
                                  type: string
                              type: object
                          type: object
                        type: array
                      replicas:
                        description: Replicas is a list of Kustomize Replicas override specifications
                        items:
                          properties:
                            count:
                              anyOf:
                                - type: integer
                                - type: string
                              description: Number of replicas
                              x-kubernetes-int-or-string: true
                            name:
                              description: Name of Deployment or StatefulSet
                              type: string
                          required:
                            - count
                            - name
                          type: object
                        type: array
                      version:
                        description: Version controls which version of Kustomize to use for rendering
                          manifests
                        type: string
                    type: object
                  path:
                    description: Path is a directory path within the Git repository, and is only
                      valid for applications sourced from Git.
                    type: string
                  plugin:
                    description: Plugin holds config management plugin specific options
                    properties:
                      env:
                        description: Env is a list of environment variable entries
                        items:
                          description: EnvEntry represents an entry in the application's environment
                          properties:
                            name:
                              description: Name is the name of the variable, usually expressed in uppercase
                              type: string
                            value:
                              description: Value is the value of the variable
                              type: string
                          required:
                            - name
                            - value
                          type: object
                        type: array
                      name:
                        type: string
                      parameters:
                        items:
                          properties:
                            array:
                              description: Array is the value of an array type parameter.
                              items:
                                type: string
                              type: array
                            map:
                              additionalProperties:
                                type: string
                              description: Map is the value of a map type parameter.
                              type: object
                            name:
                              description: Name is the name identifying a parameter.
                              type: string
                            string:
                              description: String_ is the value of a string type parameter.
                              type: string
                          type: object
                        type: array
                    type: object
                  ref:
                    description: Ref is reference to another source within sources field. This field
                      will not be used if used with a `source` tag.
                    type: string
                  repoURL:
                    description: RepoURL is the URL to the repository (Git or Helm) that contains
                      the application manifests
                    type: string
                    default: https://github.com/gopaljayanthi/appset-chart.git
                  targetRevision:
                    description: TargetRevision defines the revision of the source to sync the
                      application to. In case of Git, this can be commit, tag,
                      or branch. If omitted, will equal to HEAD. In case of
                      Helm, this is a semver tag for the Chart's version.
                    type: string
                    default: moreadv
                required:
                  - repoURL
                type: object
              type: array
          required:
            - destination
            - project
          title: argoproj.io.Application configuration options
          type: object
  steps:
    - id: serialize
      name: Serialize Application Configuration
      action: roadiehq:utils:serialize:yaml
      input:
        data:
          apiVersion: ${{ parameters.apiVersion }}
          kind: ${{ parameters.kind }}
          metadata:
            name: ${{ parameters.name }}
            namespace: ${{ parameters.namespace }}
          spec: ${{ parameters.config }}
    - id: sanitize
      name: Sanitize Configuration
      action: cnoe:utils:sanitize
      input:
        document: ${{ steps['serialize'].output.serialized }}
    - id: write-values
      name: Write values.yaml override
      action: roadiehq:utils:fs:write
      input:
        path: ./values.override.yaml
        content: ${{ parameters.config.source.valuesOverride }}
    - id: write-main-config
      name: Write Main YAML to File
      action: roadiehq:utils:fs:write
      input:
        path: ./app.yaml
        content: ${{ steps['sanitize'].output.sanitized }}
    - id: apply-main-config
      name: Apply Application Manifest
      action: cnoe:kubernetes:apply
      input:
        manifestPath: ./app.yaml
        namespaced: true
        clusterName: local
    - id: apply-values-override
      name: Apply Helm Values Override
      action: cnoe:kubernetes:apply
      input:
        manifestPath: ./values.override.yaml
        namespaced: true
        clusterName: local
